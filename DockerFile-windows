# Compile Environment for Qt Applications (windows)
# Use for apps that require QtWebEngine, you use can also use the linux container with MXE (if not required)
# DF Supply, Inc.
# Scott Moore
# 2/26/2022

FROM mcr.microsoft.com/windows/servercore:ltsc2022 as imagebase

# Install chocolatey
RUN powershell -NoProfile -ExecutionPolicy Bypass -Command \
	$Env:chocolateyVersion = '0.10.15' ; \
	$Env:chocolateyUseWindowsCompression = 'false' ; \
	"[Net.ServicePointManager]::SecurityProtocol = \"tls12, tls11, tls\"; iex ((New-Object System.Net.WebClient).DownloadString('http://chocolatey.org/install.ps1'))" && SET "PATH=%PATH%;%ALLUSERSPROFILE%\chocolatey\bin" && \
	choco feature enable -n=allowGlobalConfirmation
    
# Install Curl
RUN choco install curl --version=7.81.0

# Install .net 4.8
RUN choco install dotnetfx

# Install MSVC 2022
RUN \
	choco install visualstudio2022buildtools --ignore-package-exit-codes=3010 && \
	choco install visualstudio2022-workload-vctools --ignore-package-exit-codes=3010 --execution-timeout=7200 --package-parameters "--allWorkloads --includeRecommended --includeOptional "

# Reboot required after VS2022-workload-vctools
FROM imagebase
RUN \
	choco install visualstudio2022-workload-universal --ignore-package-exit-codes=3010 --execution-timeout=7200 --package-parameters "--allWorkloads --includeRecommended --includeOptional " && \
	choco install visualstudio2022-workload-nativedesktop --ignore-package-exit-codes=3010 --execution-timeout=7200 --package-parameters "--allWorkloads --includeRecommended --includeOptional " && \
	choco install visualstudio2022-workload-universalbuildtools --ignore-package-exit-codes=3010 --execution-timeout=7200 --package-parameters "--allWorkloads --includeRecommended --includeOptional "

# Install Git
RUN	choco install git
		
# Install JOM for multi-core builds
RUN choco install jom

# Install Perl
RUN choco install strawberryperl

# Install Ruby
RUN choco install ruby

# Install Python
RUN choco install python2

# Install Python3
RUN choco install python3

# Install sed
RUN choco install sed

# Install Ninja
RUN choco install ninja

# Install CMake
RUN choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System'

# Install LLVM
RUN choco install llvm

# install WGET
RUN choco install wget

# Setup build directories
RUN \
	mkdir build-env && \
	mkdir b && \
	mkdir qt6

# vcpkg and required packages
RUN \
	git clone https://github.com/microsoft/vcpkg && \
	cd vcpkg && \
	bootstrap-vcpkg.bat && \
#	vcpkg install angle && \
#	vcpkg install assimp && \
#	vcpkg install brotli && \
#	vcpkg install bzip2 && \
#	vcpkg install dirent && \
#	vcpkg install double-conversion && \
#	vcpkg install draco && \
#	vcpkg install egl && \
#	vcpkg install egl-registry && \
#	vcpkg install ffmpeg && \
#	vcpkg install freeglut && \
#	vcpkg install freetype && \
#	vcpkg install gettext && \
#	vcpkg install glib && \
#	vcpkg install gperf && \
#	vcpkg install gstreamer && \
#	vcpkg install harfbuzz && \
#	vcpkg install hunspell && \
#	vcpkg install icu && \
#	vcpkg install jasper && \
#	vcpkg install kubazip && \
#	vcpkg install libarchive && \
#	vcpkg install libffi && \
#	vcpkg install libiconv && \
#	vcpkg install libjpeg-turbo && \
#	vcpkg install liblzma && \
#	vcpkg install libpng && \
#	vcpkg install libpq && \
#	vcpkg install libwebp && \
#	vcpkg install libxml2 && \
#	vcpkg install libyaml && \
#	vcpkg install lz4 && \
#	vcpkg install minizip && \
#	vcpkg install open62541 && \
#	vcpkg install opengl && \
#	vcpkg install opengl-registry && \
#	vcpkg install openssl && \
#	vcpkg install pcre2 && \
#	vcpkg install pkgconf && \
#	vcpkg install poly2tri && \
#	vcpkg install pugixml && \
	vcpkg install openssl:x64-windows && \
	vcpkg install zlib:x64-windows && \
	vcpkg install libpq:x64-windows && \
	vcpkg integrate install
	
# Build Qt Source (native builds)
RUN \
	cd qt6 && \
	wget -q https://download.qt.io/official_releases/qt/6.4/6.4.2/single/qt-everywhere-src-6.4.2.zip && \
	tar -xf qt-everywhere-src-6.4.2.zip && \
	cd qt-everywhere-src-6.4.2 && \
	.\configure.bat -opensource -confirm-license -release -webengine-proprietary-codecs -nomake tests -nomake examples -qt-zlib -qt-libjpeg -qt-libpng -qt-freetype -xcb -sql-psql -sql-sqlite && \
	cmake --build . --parallel && \
	cmake --install .

# Bootstrapping msvc tools
SHELL ["powershell"]
RUN Install-PackageProvider NuGet -Force
RUN Install-Module -Name WintellectPowerShell -Force

ENTRYPOINT ["C:\\Program Files (x86)\\Microsoft Visual Studio\\2022\\BuildTools\\VC\\Auxiliary\\Build\\vcvars64.bat", "&&", "powershell.exe", "-NoLogo", "-ExecutionPolicy", "Bypass"]]
